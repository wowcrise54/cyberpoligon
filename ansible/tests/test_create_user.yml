---
- name: Verify create_user_with_passwd playbook
  hosts: test_debian          # Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ñ…Ð¾ÑÑ‚, Ñ‡Ñ‚Ð¾ Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¼ Ð¿Ð»ÐµÐ¹Ð±ÑƒÐºÐµ
  become: true
  gather_facts: false         # ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ñ‹ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ñ‹

  vars:
    # ðŸ‘‰  Ð²ÑÐµ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ÑÑ‚ Ð¸Ð· Survey Ð¸Ð»Ð¸ `-e`
    #     example_user, example_uid, example_home, example_password_hash
    #     Ð·Ð´ÐµÑÑŒ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð½Ðµ Ð½Ð°Ð´Ð¾
    verify_password_hash: true    # Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ, ÐµÑÐ»Ð¸ shadow Ð·Ð°ÐºÑ€Ñ‹Ñ‚

  tasks:
    # 1. Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² /etc/passwd
    - name: Read passwd entry for {{ example_user }}
      ansible.builtin.getent:
        database: passwd
        key: "{{ example_user }}"
      register: user_entry
      tags: always

    # 2. Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
    - name: Assert user exists and basic properties match
      ansible.builtin.assert:
        that:
          - user_entry.entries | length > 0
          - (user_entry.entries[0].uid | int) == (example_uid | int)
          - user_entry.entries[0].dir == example_home
      tags: always

    # 3. Ð§Ð¸Ñ‚Ð°ÐµÐ¼ /etc/shadow (Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ pam-access Ð¸Ð»Ð¸ --ask-become-pass)
    - name: Read shadow entry for {{ example_user }}
      ansible.builtin.getent:
        database: shadow
        key: "{{ example_user }}"
      register: shadow_entry
      when: verify_password_hash | bool
      tags: always

    # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ…ÑÑˆ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚
    - name: Assert password hash matches what was requested
      ansible.builtin.assert:
        that:
          - shadow_entry.entries | length > 0
          - shadow_entry.entries[0].password == example_password_hash
      when: verify_password_hash | bool
      tags: always