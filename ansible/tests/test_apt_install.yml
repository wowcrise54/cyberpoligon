---
- name: Verify apt_install playbook
  hosts: test_debian
  become: true

  tasks:
    # 0️⃣ Приводим переменную pkg_list к списку:
    #    – если пришла строка «curl,htop», превращаем в ["curl", "htop"],
    #    – если уже список — оставляем как есть.
    - name: Normalize pkg_list to list
      ansible.builtin.set_fact:
        pkg_effective: >-
          {{ (pkg_list.split(',') | map('trim') | list) if (pkg_list is string) else (pkg_list | list) }}
      tags: always

    - name: Collect package facts
      ansible.builtin.package_facts:
      tags: always

    - name: Assert every requested package is installed
      ansible.builtin.assert:
        that: "'{{ item }}' in ansible_facts.packages"
      loop: "{{ pkg_effective }}"
      tags: always
---
- name: Verify apt_install playbook
  hosts: test_debian
  become: true

  tasks:
    - name: Collect package facts
      ansible.builtin.package_facts:
      tags: always

    - name: Assert every requested package is installed
      ansible.builtin.assert:
        that: "'{{ item }}' in ansible_facts.packages"
      loop: "{{ pkg_list | flatten }}"
      tags: always
---
- name: Verify apt_install playbook
  hosts: test_debian
  become: true

  tasks:
    - name: Collect package facts
      ansible.builtin.package_facts:

    - name: Assert every requested package is installed
      ansible.builtin.assert:
        that: "'{{ item }}' in ansible_facts.packages"
      loop: "{{ pkg_list | flatten }}"